import { Usuario, Rol } from '../models/index.js'; import { hash, compare } from '../utils/bcrypt.utils.js'; import { signJwt } from '../utils/jwt.utils.js'; export async function register(req,res){ const {nombre,apellido,correo,password,rol}=req.body; if(!nombre||!apellido||!correo||!password||!rol) return res.status(400).json({message:'Campos obligatorios'}); const exists=await Usuario.findOne({where:{correo}}); if(exists) return res.status(409).json({message:'Correo ya registrado'}); const rolEntity=await Rol.findOne({where:{nombre:rol}})||await Rol.create({nombre:rol}); const password_hash=await hash(password); const user=await Usuario.create({nombre,apellido,correo,password_hash,id_rol:rolEntity.id}); return res.status(201).json({id:user.id,nombre,apellido,correo,rol}); } export async function login(req,res){ const {correo,password}=req.body; const user=await Usuario.findOne({where:{correo}, include: Rol}); if(!user) return res.status(401).json({message:'Credenciales inválidas'}); const ok=await compare(password,user.password_hash); if(!ok) return res.status(401).json({message:'Credenciales inválidas'}); const token=signJwt({sub:user.id,rol:user.rol.nombre,correo:user.correo}); res.json({token,user:{id:user.id,nombre:user.nombre,rol:user.rol.nombre}}); } export async function me(req,res){ res.json({me:req.user}); }
